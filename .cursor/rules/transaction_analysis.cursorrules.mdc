---
schema: 1
scope: workspace
description: Transaction analysis rules - RPC usage, data enrichment, activation gate
globs:
  - '**/*'
---

## Activation Gate

**Apply ONLY when:**

- User provides tx hash + network name AND asks to analyze/debug that specific transaction
- Phrases like: "analyze this transaction", "debug this failing tx", "why did this bridge/swap revert?" (or similar variations)

**Do NOT apply for:**

- General Solidity/Foundry questions
- Deployment questions not tied to a single transaction
- High-level protocol/architecture questions
- Requests without concrete tx hash

If partially matched (e.g., hash but no network), ask for missing info before entering transaction-analysis mode.

## Transaction Analysis Mode

When activated:

1. **Load**: `.cursor/prompts/transaction_analysis.md` as primary playbook
2. **Follow**: "Critical Rules" and "QUALITY CHECKS" sections are mandatory
3. **Use this file for**: RPC policy, data sources, safety constraints

## RPC Usage Policy

- **Premium RPCs only**: NEVER default to public RPCs (including `config/networks.json.rpcUrl`)
- **Preferred**: Use `getRPCUrl "<NETWORK>"` via `analyzeFailingTx` in `script/playgroundHelpers.sh`
- **Fallback**: Ask user for premium RPC URL (same as `.env`/CI)
- **Never expose**: RPC URLs or secret env var names in responses

## Data Fetching

**Preferred (shell access):**

```bash
bash -lc 'source script/helperFunctions.sh && source script/playgroundHelpers.sh && analyzeFailingTx "<NETWORK>" "<TX_HASH>"'
```

**Fallback (no shell):**

- Ask user for premium RPC URL
- Use for read-only JSON-RPC: `eth_getTransactionReceipt`, `debug_traceTransaction` (callTracer)
- Never silently fall back to public RPCs

## Address Enrichment (MANDATORY)

**Sources (in order):**

1. `config/whitelist.json`:
   - **DEXS section**: `DEXS[]` → `contracts[<network>]` → match address (case-insensitive) → use `name` field
   - **PERIPHERY section**: `PERIPHERY[<network>]` → match address → use `name` field
2. `deployments/<network>.json` (fallback)
3. Facet config files from `config/*.json`
4. `config/networks.json` (metadata only, not RPC URLs)
5. **For token addresses**: MAY call ERC20 `name()` via premium RPC (read-only, non-fatal failures)

**Rules:**

- Never use generic terms ("DexRouter", "Router", "DEX") when specific name available
- Case-insensitive address matching

## Scope Detection

First confirm: Was LiFiDiamond involved (directly or indirectly)? If not, state: "This is not one of our transactions."

## Analysis Behavior

- Prefer deterministic, fully explained analyses
- Follow output template in `transaction_analysis.md`
- Keep explanations concise but structured
