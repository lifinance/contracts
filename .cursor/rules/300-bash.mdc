---
name: Bash scripts
description: Deployment bash structure and safety
globs:
  - '**/*.sh'
---

## Bash Deployment Framework

- Start with `#!/bin/bash`; organize into functions (logging, error handling, deployment); keep DRY via helpers.
- **Use existing helpers**: Source `script/helperFunctions.sh` and `script/playgroundHelpers.sh` for reusable functions (deployment, verification, network queries, logging, etc.). Prefer existing helpers over reimplementing logic.
- Load env from `.env`/`config.sh`; validate required vars early; update `.env.example` when adding envs; add system deps to `preinstall.sh` when needed.
- Use logging helpers (`echoDebug`, `error`, `warning`, `success`) and `checkFailure`; implement retries for RPC-sensitive steps; avoid inline secrets.
- Variable names: all uppercase (e.g., `NETWORK`, `CONTRACT_ADDRESS`).
- Provide usage/help text; clear exit codes; document TODOs/limits succinctly; keep indentation and naming consistent.

## Key Helper Functions [CONV:BASH-HELPERS]

### Network Abstraction Helpers

Use these helpers to abstract Tron vs EVM network differences. **Never hardcode network checks** like `if [[ "$NETWORK" == "tron" ]]`; use the helpers instead.

| Helper | Purpose |
|--------|---------|
| `isTronNetwork "$NETWORK"` | Returns 0 (true) if network is Tron-based |
| `getTronEnv "$NETWORK"` | Returns "mainnet" or "testnet" for troncast --env |
| `getRPCUrl "$NETWORK"` | Gets RPC URL for EVM networks |
| `getPrivateKey "$NETWORK" "$ENVIRONMENT"` | Gets private key for network/environment |

### Validation Helpers (helperFunctions.sh)

Reuse these instead of inline regex for selector/address checks:

| Helper | Purpose |
|--------|---------|
| `isValidSelector VALUE` | Returns 0 if bytes4 selector (0x + 8 hex) |
| `isValidEvmAddress VALUE` | Returns 0 if EVM address (0x + 40 hex) |
| `isValidTronAddress VALUE` | Returns 0 if Tron Base58 (T + 33 alphanumeric) |
| `isZeroAddress VALUE` | Returns 0 if zero address (0x0...0) |

### Contract Interaction Helpers

**Preferred**: use `universalCast ACTION NETWORK [rest...]` so all cast-like operations go through one entry point. New networks are handled inside the underlying helpers and `universalCast` supports them automatically.

```bash
# universalCast "call" NETWORK TARGET SIGNATURE [ARGS...]
RESULT=$(universalCast "call" "$NETWORK" "$DIAMOND" "owner() returns (address)")
BALANCE=$(universalCast "call" "$NETWORK" "$TOKEN" "balanceOf(address) returns (uint256)" "$USER")

# universalCast "send" NETWORK ENVIRONMENT TARGET SIGNATURE [ARGS] [TIMELOCK] [PRIVATE_KEY_OVERRIDE]
universalCast "send" "$NETWORK" "$ENVIRONMENT" "$DIAMOND" "setFee(uint256)" "100"
universalCast "send" "$NETWORK" "production" "$DIAMOND" "batchSet(address[],bool)" '[addr1,addr2] true' "true"
# With specific key (e.g. pauser, old/new owner): pass as last arg
universalCast "send" "$NETWORK" "production" "$DIAMOND" "pauseDiamond()" "" "" "$PRIVATE_KEY_PAUSER_WALLET"

# universalCast "code" NETWORK ADDRESS
CODE=$(universalCast "code" "$NETWORK" "$ADDRESS" 2>/dev/null || echo "0x")

# universalCast "sendRaw" NETWORK ENVIRONMENT TARGET CALLDATA [PRIVATE_KEY_OVERRIDE] (used internally by sendOrPropose)
universalCast "sendRaw" "$NETWORK" "$ENVIRONMENT" "$TARGET" "$CALLDATA"
universalCast "sendRaw" "$NETWORK" "$ENVIRONMENT" "$TARGET" "$CALLDATA" "$PRIVATE_KEY_OVERRIDE"
```

You can also call `universalCall`, `universalSend`, `universalSendRaw`, or `universalCode` directly (they are what `universalCast` dispatches to). **Optional private key override**: For `universalSend`, `universalSendRaw`, and `sendOrPropose`, pass a hex private key as the last (optional) argument to use that key instead of `getPrivateKey(NETWORK, ENVIRONMENT)` (e.g. for pauser wallet or old/new owner flows).

**For raw calldata transactions**, use `sendOrPropose` (internally uses `universalCast "sendRaw"` for Tron and EVM staging; EVM production uses propose-to-safe.ts):
```bash
# sendOrPropose NETWORK ENVIRONMENT TARGET CALLDATA [TIMELOCK] [PRIVATE_KEY_OVERRIDE]
CALLDATA=$(cast calldata "transfer(address,uint256)" "$TO" "$AMOUNT")
sendOrPropose "$NETWORK" "$ENVIRONMENT" "$TARGET" "$CALLDATA" "true"
```

### Routing Behavior for universalCast

| Function | Tron | EVM Production | EVM Staging |
|----------|------|----------------|-------------|
| `universalCall` | troncast call | cast call | cast call |
| `universalSend` | troncast send (direct) | propose-to-safe.ts | cast send (direct) |
| `universalSendRaw` | troncast send (direct) | (not used) | cast send (direct) |
| `universalCode` | troncast code | cast code | cast code |


### Function Documentation Format

When adding or modifying helper functions, use this consistent documentation format:

```bash
# functionName: Brief description of what the function does.
# Additional context or behavior notes if needed.
#
# Usage: functionName ARG1 ARG2 [OPTIONAL_ARG] [OPTIONAL_FLAG]
#   ARG1          - Description of first argument
#   ARG2          - Description of second argument
#   OPTIONAL_ARG  - Optional: Description with default behavior
#   OPTIONAL_FLAG - Optional: "true" to enable feature (default: false)
#
# Routing/Behavior (if applicable):
#   - Case 1: What happens in this case
#   - Case 2: What happens in this case
#
# Returns: Description of return value and exit code behavior
# Example: functionName "value1" "value2"
# Example: functionName "value1" "value2" "optional" "true"
function functionName() {
```

**Key conventions**:
- Parameter names in UPPERCASE in both documentation and code
- Use `-` dash separator for parameter descriptions (not `:`)
- Group optional parameters with `Optional:` prefix
- Include routing/behavior section for functions with branching logic
- Provide concrete examples

## Syntax Validation (CRITICAL)

**All bash code must be validated before suggesting changes.**

### Required Steps

1. **Syntax**: `bash -n <script>` - always run before suggesting changes
2. **Unbound variables** (with `set -euo pipefail`):
   - Use `${VAR:-}` not `$VAR`; `${ARRAY[@]:-}` not `-v ARRAY[@]`
   - Check `${#ARRAY[@]}` before accessing arrays
3. **Compatibility**: bash 5.0+ (macOS default); avoid bash 4.0-only features
4. **Test strict mode**: `bash -c 'set -euo pipefail; source script.sh'`

### Validation Checklist

- [ ] `bash -n` syntax check passes
- [ ] No unbound variable errors with `set -u`
- [ ] Array access tested with empty arrays
- [ ] Parameter expansion uses `:-` defaults
- [ ] Conditionals work in strict mode

### Common Pitfalls

- Arrays: `${ARRAY[@]:-}` not `-v ARRAY[@]`
- Variables: `${VAR:-default}` when `set -u` enabled
- Process substitution: `< <(...)` requires `#!/bin/bash` shebang
- Conditionals: `[[ ]]` not `[ ]` for bash-specific features
- Variable case: Use `UPPERCASE` for all variables, including `local` declarations and loop iterators
