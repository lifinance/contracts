name: JSON Checker
# - checks selected JSON files for semantic issues and fails if any issues are found
# - validates the following locations/files:
#   - config/*.json
#   - deployments/*.json
#   - audit/auditLog.json
#   - script/deploy/_targetState.json
#   - script/deploy/resources/deployRequirements.json

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate-json:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: 20

      # Step 3: Install jsonlint
      - name: Install jsonlint
        run: npm install -g jsonlint

      # Step 4: Find and validate JSON files
      - name: Validate JSON files
        run: |
          set -e

          # Function to validate all files in a directory
          validate_files() {
            dir=$1
            echo "Checking JSON files in $dir now"
            for file in $dir/*.json; do
              if [ -f "$file" ]; then
                echo "Validating $file"
                jsonlint "$file"
              fi
            done
          }

          # Validate all JSON files in the specified directories
          validate_files config
          validate_files deployments

          echo "Checking audit log now"
          jsonlint audit/auditLog.json

          echo "Checking target state now"
          jsonlint script/deploy/_targetState.json

          echo "Checking deploy requirements now"
          jsonlint script/deploy/resources/deployRequirements.json
