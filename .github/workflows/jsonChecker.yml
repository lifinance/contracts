name: JSON Checker
# - checks selected JSON files for semantic issues and fails if any issues are found
# - validates the following locations/files:
#   - config/*.json
#   - deployments/*.json
#   - audit/auditLog.json
#   - script/deploy/_targetState.json
#   - script/deploy/resources/deployRequirements.json

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate-json:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: 20

      # Step 3: Install jsonlint
      - name: Install jsonlint
        run: npm install -g jsonlint

      # Step 4: Find and validate JSON files
      - name: Validate JSON files
        run: |

          set -e

          # Function to validate JSON files
          validate_json() {
            local path="$1"
            # Check if path exists
            if [ -e "$path" ]; then
              echo "Checking $path"
              # Check if path is a directory
              if [ -d "$path" ]; then
                find "$path" -type f -not -type l -name "*.json" -exec sh -c '
                  for file; do
                    echo "Validating $file"
                    # Check file size
                    file_size=$(wc -c < "$file")
                    if [ "$file_size" -gt '"$max_size"' ]; then
                      echo -e "\033[31mError: $file exceeds 5MB limit\033[0m"
                      exit 1
                    fi
                    # Validate JSON and exit with error if it fails
                    jsonlint --quiet "$file" || exit 1
                  done
                ' sh {} +
              else
                # Validate a single file
                if [ -L "$path" ]; then
                  echo -e "\033[31mError: $path is a symlink\033[0m"
                  exit 1
                fi
                # Check file size
                if [ "$(stat -f%z "$path")" -gt "$max_size" ]; then
                  echo -e "\033[31mError: $path exceeds 5MB limit\033[0m"
                  exit 1
                fi
                jsonlint --quiet "$path" || exit 1
              fi
            else
              echo -e "\033[31mWarning: $path does not exist\033[0m"
            fi
          }

          validate_json "config"
          echo -e "\033[32mAll files in folder config/ validated.\033[0m"

          validate_json "deployments"
          echo -e "\033[32mAll files in folder deployments/ validated.\033[0m"

          validate_json "audit/auditLog.json"
          echo -e "\033[32mauditLog.json validated.\033[0m"

          validate_json "script/deploy/_targetState.json"
          echo -e "\033[32m_targetState.json validated.\033[0m"
