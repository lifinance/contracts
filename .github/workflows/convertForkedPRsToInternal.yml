# This GitHub Action automatically handles PRs opened from forked repositories.
# Context:
# - Forked PRs cannot access secrets or run CI in this repo due to security restrictions.
# - To continue the contribution process, we need to recreate the PR using a local branch.
#
# Security: All user-controlled inputs (PR title, body, fork repo/ref) are passed via step
# env only and never interpolated into the script body, to prevent RCE via malicious PR titles.
#
# What this action does:
# âœ… Detects if a PR comes from a fork.
# âœ… Fetches the forked PR branch and creates a new local branch in the main repo.
# âœ… Opens a new PR from that local branch using the original PR's title and body.
# âœ… Comments on the new PR and the original one to link them clearly.
# âœ… Closes the original forked PR.
#
# Additional Notes:
# - Uses GitHub CLI (`gh`) to create and comment on PRs.
# - Uses the bot's Personal Access Token to ensure permissions for editing/closing PRs.
# - Ensures actions and CI can run safely on the new PR.

name: Convert Fork PR to Internal PR

on:
  pull_request_target:
    types: [opened]

permissions:
  contents: write
  pull-requests: write

jobs:
  handle-fork-pr:
    if: github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    concurrency:
      group: fork-pr-migration-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    env:
      GH_TOKEN: ${{ secrets.GIT_ACTIONS_BOT_PAT_CLASSIC }}

    steps:
      - name: Checkout base branch
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Fetch forked branch content
        id: fetch_fork
        env:
          # Pass event data via env to prevent RCE: user-controlled values must not
          # be interpolated into the script body (see CVE-style RCE via PR title/body).
          FORK_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          FORK_REF: ${{ github.event.pull_request.head.ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          git config --global user.name "Lifi Bot"
          git config --global user.email "actions@users.noreply.github.com"

          # Sanitize repo and ref (read from env; never interpolate into script)
          SAFE_FORK_REPO=$(printf '%s' "$FORK_REPO" | sed 's/[^a-zA-Z0-9_.\/-]//g')
          SAFE_FORK_REF=$(printf '%s' "$FORK_REF" | sed 's/[^a-zA-Z0-9_.\/-]//g')
          NEW_BRANCH="fork-pr-${PR_NUMBER}"
          SAFE_NEW_BRANCH=$(printf '%s' "$NEW_BRANCH" | sed 's/[^a-zA-Z0-9_.\/-]//g')

          # Check if branch already exists
          if git show-ref --verify --quiet refs/remotes/origin/"$SAFE_NEW_BRANCH"; then
            echo "Branch $SAFE_NEW_BRANCH already exists, using timestamp suffix"
            SAFE_NEW_BRANCH="${SAFE_NEW_BRANCH}-$(date +%s)"
          fi

          echo "SAFE_NEW_BRANCH=$SAFE_NEW_BRANCH" >> $GITHUB_ENV

          git remote add fork "https://github.com/${SAFE_FORK_REPO}.git"
          git fetch fork "$SAFE_FORK_REF"
          git checkout -b "$SAFE_NEW_BRANCH" FETCH_HEAD
          git push origin "$SAFE_NEW_BRANCH"

      - name: Create internal PR
        id: create_internal_pr
        env:
          # Pass all user/event inputs via env to prevent RCE (no interpolation into script).
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          ORIGINAL_PR_NUMBER: ${{ github.event.pull_request.number }}
          ORIGINAL_PR_URL: https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}
          ORIGINAL_AUTHOR: '@${{ github.event.pull_request.user.login }}'
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          BODY_CONTENT="${PR_BODY:-No original PR description.}"

          # Build PR body file with printf only (no heredoc with user content = no RCE).
          {
            printf '> ðŸ”„ This PR was created automatically from external PR [#%s](%s) for CI/security purposes.\n\n' "$ORIGINAL_PR_NUMBER" "$ORIGINAL_PR_URL"
            printf 'Original PR by %s: %s\n\n---\n\n' "$ORIGINAL_AUTHOR" "$ORIGINAL_PR_URL"
            printf '%s' "$BODY_CONTENT"
          } > /tmp/pr_body.md

          NEW_PR_URL=$(gh pr create \
            --base "$BASE_REF" \
            --head "$SAFE_NEW_BRANCH" \
            --title "$PR_TITLE" \
            --body-file /tmp/pr_body.md)

          echo "NEW_PR_URL=$NEW_PR_URL" >> $GITHUB_ENV
          echo "NEW_PR_NUMBER=$(basename "$NEW_PR_URL")" >> $GITHUB_ENV

      - name: Comment on new PR linking original
        run: |
          set -euo pipefail
          NEW_PR_NUMBER=$(echo "$NEW_PR_URL" | awk -F'/' '{print $NF}')
          ORIGINAL_PR_NUMBER="${{ github.event.pull_request.number }}"

          gh pr comment "$NEW_PR_NUMBER" --body "This PR was created from #$ORIGINAL_PR_NUMBER (external fork) to enable full CI and audit checks."

      - name: Comment and close original PR
        run: |
          set -euo pipefail
          ORIGINAL_PR="${{ github.event.pull_request.number }}"

          COMMENT_BODY="Thanks for your contribution! ðŸ™Œ

Unfortunately, we can't run GitHub Actions or access required secrets on PRs from forked repositories.

To proceed, we've copied your changes to a new internal PR that our CI can safely test and audit:
ðŸ‘‰ $NEW_PR_URL

We're closing this PR in favor of continuing the review on the new one. Please follow progress there!"

          gh pr comment "$ORIGINAL_PR" --body "$COMMENT_BODY"
          gh pr close "$ORIGINAL_PR"

      - name: Cleanup on failure
        if: failure()
        run: |
          set -euo pipefail
          echo "Action failed, cleaning up temporary branch if it exists"
          if [ -n "$SAFE_NEW_BRANCH" ]; then
            git push origin --delete "$SAFE_NEW_BRANCH" || true
          fi
