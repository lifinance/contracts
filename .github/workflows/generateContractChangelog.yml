# Generate Contract Changelog
# - Triggers when a PR is merged to main that modified Solidity contracts
# - Also triggers on push to test branch (SMAR-41-Research-how-we-can-auto-generate-contract-changelogs-using-AI)
# - Writes changelog/CHANGELOG.md (all commits, newest first) and changelog/contracts/{Contract}.md per contract
# - Commits changelog/ to the branch
# - Supports manual execution via workflow_dispatch
# - Uses Anthropic Claude Sonnet (CLAUDE_CODE_SC_CONTRACTS_REPO_CHANGELOGS_API_KEY)

name: generateContractChangelog

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - 'src/**/*.sol'
  push:
    branches:
      - 'SMAR-41-Research-how-we-can-auto-generate-contract-changelogs-using-AI'
    paths:
      - 'src/**/*.sol'
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to analyze (leave empty for latest)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-changelog:
    # Only run if: (1) PR was merged (not just closed), OR (2) manually triggered, OR (3) push to test branch
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref || github.ref }} # Checkout target branch (main for PRs, current branch for pushes)
          fetch-depth: 0 # Need full history for diff analysis
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate changelog
        id: generate
        run: |
          echo "ðŸ¤– Running AI-powered changelog generation (Claude Sonnet)"
          bun run script/changelogAnalysis/generateContractChangelog.ts
        env:
          COMMIT_SHA: ${{ github.event.inputs.commit_sha || github.event.pull_request.merge_commit_sha || github.sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          CLAUDE_CODE_SC_CONTRACTS_REPO_CHANGELOGS_API_KEY: ${{ secrets.CLAUDE_CODE_SC_CONTRACTS_REPO_CHANGELOGS_API_KEY }}

      - name: Check for changes
        id: check
        run: |
          if git diff --name-only | grep -q "^changelog/"; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "changelog/ updated"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No changelog changes"
          fi

      - name: Commit and push changelog
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add changelog/
          COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)
          git commit -m "chore: add contract changelog for commit ${COMMIT_SHA_SHORT}"
          git push

      - name: Summary
        if: always()
        run: |
          echo "## Contract Changelog Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Mode**: ðŸ¤– AI-powered semantic analysis (Claude Sonnet)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check.outputs.has_changes }}" == "true" ]; then
            echo "âœ… changelog/ updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Updated:" >> $GITHUB_STEP_SUMMARY
            git diff --name-only | grep "^changelog/" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Contract changes analyzed:" >> $GITHUB_STEP_SUMMARY
            # Show files from the merged PR or push
            if [ -n "${{ github.event.pull_request.number }}" ]; then
              echo "**PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
            fi
            git diff HEAD~1 --name-only --diff-filter=AM src/**/*.sol 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- (see commit for details)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No contract changes or commit already in changelog" >> $GITHUB_STEP_SUMMARY
          fi
